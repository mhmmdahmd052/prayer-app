<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>لوحة مراقبة أوقات الصلاة - بيشكك</title>
<style>
body { font-family: Arial, sans-serif; background: #f9f9f9; color: #333; padding: 20px; }
h1 { text-align: center; margin-bottom: 10px; }
#current-time { text-align: center; font-size: 1.2em; margin-bottom: 20px; }
table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
th, td { border: 1px solid #ccc; padding: 5px; text-align: center; }
th { background-color: #eee; }
.next-prayer { background-color: #d4edda; font-weight: bold; }
</style>
</head>
<body>

<h1>لوحة مراقبة أوقات الصلاة - بيشكك</h1>
<div id="current-time">جارٍ تحميل الوقت...</div>
<table id="prayer-table">
    <thead>
        <tr>
            <th>التاريخ</th>
            <th>الفجر</th>
            <th>الشروق</th>
            <th>الظهر</th>
            <th>العصر</th>
            <th>المغرب</th>
            <th>العشاء</th>
            <th>الصلاة القادمة</th>
            <th>العد التنازلي</th>
        </tr>
    </thead>
    <tbody id="calendar-body">
        <tr><td colspan="9">جارٍ تحميل البيانات...</td></tr>
    </tbody>
</table>

<script>
let lastDataJSON = null;

function updateCurrentTime() {
    const now = new Date();
    const formattedTime = now.toLocaleTimeString('ar-EG', { hour12: false });
    document.getElementById("current-time").textContent = `الوقت الحالي: ${formattedTime}`;
}

function getCountdown(targetTime) {
    const now = new Date();
    const diff = targetTime - now;
    if(diff <= 0) return "انتهت";
    const hours = Math.floor(diff/1000/3600);
    const minutes = Math.floor((diff/1000%3600)/60);
    const seconds = Math.floor(diff/1000%60);
    return `${hours.toString().padStart(2,'0')}:${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
}

function getNextPrayerCountdown(day) {
    const now = new Date();
    const prayerTimes = ['fajr','shurooq','zuhr','asr','maghrib','isha'];
    for(let pt of prayerTimes){
        const [hours, minutes] = day[pt].split(':').map(Number);
        const prayerDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes);
        if(prayerDate > now) return {name: pt, countdown: getCountdown(prayerDate), diff: (prayerDate-now)/60000};
    }
    return {name: 'انتهت', countdown: '-', diff: 0};
}

function getCountdownColor(diffMinutes) {
    if(diffMinutes > 30) return "green";
    if(diffMinutes > 10) return "orange";
    if(diffMinutes >= 0) return "red";
    return "black";
}

async function fetchPrayerCalendar() {
    const tbody = document.getElementById("calendar-body");
    try {
        const corsProxy = "https://api.allorigins.win/get?url=";
        const url = corsProxy + encodeURIComponent("https://muftiyat.kg/ru/api/v1/calendar/1/");
        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const textData = await response.json();
        const data = JSON.parse(textData.contents);

        const currentDataJSON = JSON.stringify(data);
        if(currentDataJSON === lastDataJSON) return;
        lastDataJSON = currentDataJSON;

        tbody.innerHTML = "";
        let todayRow = null;

        data.forEach((day) => {
            const [dayNum, monthNum, yearNum] = day.date.split('-').map(Number);
            const dateObj = new Date(yearNum, monthNum - 1, dayNum);
            const arabicDate = dateObj.toLocaleDateString('ar-EG', { weekday:'short', year:'numeric', month:'short', day:'numeric' });

            const nextPrayer = getNextPrayerCountdown(day);
            const nextPrayerName = {
                'fajr':'الفجر', 'shurooq':'الشروق', 'zuhr':'الظهر', 'asr':'العصر', 'maghrib':'المغرب', 'isha':'العشاء','انتهت':'انتهت'
            }[nextPrayer.name];

            const countdownColor = getCountdownColor(nextPrayer.diff);

            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${arabicDate}</td>
                <td>${day.fajr}</td>
                <td>${day.shurooq}</td>
                <td>${day.zuhr}</td>
                <td>${day.asr}</td>
                <td>${day.maghrib}</td>
                <td>${day.isha}</td>
                <td class="${nextPrayer.name !== 'انتهت' ? 'next-prayer':''}">${nextPrayerName}</td>
                <td style="color:${countdownColor}">${nextPrayer.countdown}</td>
            `;
            tbody.appendChild(row);

            if(dateObj.toDateString() === new Date().toDateString()) todayRow = row;
        });

        if(todayRow){
            todayRow.scrollIntoView({behavior:"smooth", block:"center"});
        }

    } catch (error) {
        console.error("خطأ في جلب أوقات الصلاة:", error);
        tbody.innerHTML = "<tr><td colspan='9'>فشل تحميل أوقات الصلاة</td></tr>";
    }
}

setInterval(updateCurrentTime, 1000);
setInterval(fetchPrayerCalendar, 1000);

updateCurrentTime();
fetchPrayerCalendar();
</script>

</body>
</html>